<% const badgeClass = (lvl)=> lvl==='critical'?'badge-critical':(lvl==='at_risk'?'badge-risk':'badge-normal'); %>
<% const badgeText = (lvl)=> lvl==='critical'?'Crítico':(lvl==='at_risk'?'En riesgo':'Normal'); %>

<%- include('../../partials/layout', { title, body: `
  <div class='glass soft-shadow rounded-3xl p-6 sm:p-8 fade-in'>
    <div class='flex flex-col lg:flex-row lg:items-end justify-between gap-4'>
      <div>
        <div class='text-2xl font-extrabold'>Respuestas de estudiantes</div>
        <div class='text-sm text-slate-600 mt-1'>Aquí puedes ver todas las respuestas, abrir un caso y clasificarlo manualmente.</div>
      </div>

      <form class='flex flex-col sm:flex-row gap-3 w-full lg:w-auto' method='GET' action='/admin/questionnaires'>
        <input class='input sm:w-[280px]' name='q' value='${escapeHtml(filters.q||'')}' placeholder='Buscar por nombre o correo…' />
        <select class='input sm:w-[180px]' name='level'>
          <option value=''>Todos los estados</option>
          <option value='normal' ${filters.level==='normal'?'selected':''}>Normal</option>
          <option value='at_risk' ${filters.level==='at_risk'?'selected':''}>En riesgo</option>
          <option value='critical' ${filters.level==='critical'?'selected':''}>Crítico</option>
        </select>
        <button class='btn btn-primary sm:w-[140px]' type='submit'>Filtrar</button>
      </form>
    </div>

    <div class='mt-6 overflow-auto'>
      <table class='table'>
        <thead>
          <tr>
            <th>Estudiante</th>
            <th>Correo</th>
            <th>Estado</th>
            <th>Fecha</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          ${rows.length ? rows.map(r=>`
            <tr>
              <td class='font-bold'>${escapeHtml(r.full_name)}</td>
              <td class='text-slate-700'>${escapeHtml(r.email)}</td>
              <td><span class='badge ${badgeClass(r.risk_level)}'>${badgeText(r.risk_level)} · ${r.risk_score}</span></td>
              <td class='text-slate-700'>${new Date(r.created_at+'Z').toLocaleString('es-ES')}</td>
              <td class='text-right'><a class='btn btn-secondary' href='/admin/questionnaires/${r.id}'>Abrir</a></td>
            </tr>
          `).join('') : `
            <tr>
              <td colspan='5' class='text-slate-600'>No hay resultados con esos filtros.</td>
            </tr>
          `}
        </tbody>
      </table>
    </div>

    <div class='mt-6 flex flex-col sm:flex-row gap-3'>
      <a class='btn btn-secondary' href='/admin'>Volver al panel</a>
      <a class='btn btn-secondary' href='/admin/users'>Administradores</a>
      <a class='btn btn-secondary' href='/admin/chat'>Chat Admin</a>
    </div>
  </div>
` }) %>

<% function escapeHtml(str){
  return String(str)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#39;');
}
%>
